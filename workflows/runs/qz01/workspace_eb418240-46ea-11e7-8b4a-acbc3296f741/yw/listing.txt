####################################################################################
dwca_branching_taxon_lookup.yaml
####################################################################################
This workflow:
- creates a given directory as a workspace
- downloads a given Darwin Core Archive from a URL
- extracts the core file of a Darwin Core Archive to a tab-separated text file
- streams the core file as records
- adds a key/value pair isMarine,true to records appearing to contain marine data
- splits the stream, one branch accepting isMarine=true the other rejecting it.
- TODO: lookup in WoRMS on one stream, look up in GBIF on the other
- recombines the streams into a csv file
- wraps up the workflow
Example command-line usage:
kurator -f dwca_branching_taxon_lookup.yaml
-p workspace=./dwca_geography_assessor_workspace
-p dwca_url=http://ipt.vertnet.org:8080/ipt/archive.do?r=ccber_mammals
-l DEBUG (optional)
Requires:
jython pip install requests
jython pip install python-dwca-reader
jython pip install py
jython pip install unicodecsv
jython pip install unidecode
####################################################################################
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
__author__ = "John Wieczorek"
__author__ = "Paul J. Morris"
__copyright__ = "Copyright 2017 President and Fellows of Harvard College"
__version__ = "dwca_braching_taxon_lookup.yaml 2017-05-18T08:14-04:00"
Definitions of the Workflow and actors
## The named workflow ###
Actors invoked in the workflow. Every actor that will be invoked must be on this
list. Though the order does not matter, it is helpful to keep the list in more
or less the order in which they'll be invoked, for clarity.
Each parameter defined here enters the workflow from the command line and is
delivered in the options dictionary of the specified actor.
Accept a parameter called dwca_url from the command line.
Set the url in the options dictionary of DownloadArchive from the value of
the dwca_url parameter given on the command line.
Accept a parameter called workspace from the command line.
Set the workspace in the options dictionary of MakeWorkspace from the value of
the workspace parameter given on the command line.
@BEGIN BranchingWorkflow
@IN DwCA_URI
@PARM LogFile
Inline python actor to make a workspace on the fly to use for writing temporary
if one is not supplied in the workflow-defined parameters. It creates a unique
workspace if a workspace location is not explicitly provided, or if the provided
one does not exist.
@BEGIN Setup
@PARAM DwCA_URI
@IN DarwinCoreArchive @URI {DwCA_URI}
Inline python code to run.
The function to run when an on_start message is received. Accepts a dictionary
of options.
## Started MakeWorkspace ###'
Download a Darwin Core archive from a URL given by workflow-defined url parameter.
Download occurs in workspace provided by the upstream actor.
The location of the actor source code
The function to invoke in the module when the actor receives an onData message.
A list of parameters to get from the options dictionary passed from an
upstream actor.
Get the workspace for this actor from the workspace in the options dictionary.
Get the success state from the options dictionary of the previous step
Get the message from the options dictionary of the previous step
A list of parameters to get from the parameters defined at the workflow level or
to set explicitly from values given in this section.
Get the url for the options dictionary from the url parameter defined
in the Workflow. It is not declared here.
NOTE: Would like to establish the command line source of a parameter here, within
the actor.
Set the outputfile to a specific file name.
NOTE: Would like to be able to specify that this file should go in the workspace
Set the log level in the actor explicitly
NOTE: Invoking logging in the Python actor causes kurator-akka thread exceptions.
loglevel: 'DEBUG'
Show the name of the upstream actor.
The "upstream" actor from which to receive a message.
Extract core file into a tab-separated value file in workspace from Darwin Core archive.
The location of the actor source code
The function to invoke in the module when the actor receives an onData message.
A list of parameters to get from the options dictionary passed from an
upstream actor.
Get the inputfile for this actor from the outputfile in the options dictionary.
Get the workspace for this actor from the workspace in the options dictionary.
Get the success state from the options dictionary of the previous step
Get the message from the options dictionary of the previous step
A list of parameters to get from the parameters defined at the workflow level or
to set explicitly from values given in this section.
Set the outputfile to a specific file name.
NOTE: Would like to be able to specify that this file should go in the workspace
Show the name of the upstream actor.
The "upstream" actor from which to receive a message.
@OUT Workspace
@OUT OccurrenceFile @URI file:{Workspace}/dwca_extracted_occurrences.txt
@END Setup
take the extracted occurrence core and stream records from it
@BEGIN FileToDataStream
@IN OccurrenceFile
@OUT DataRecord
@END FileToDataStream
Tag each record in the stream that appears to be marine with isMarine=true
@BEGIN EnvironmentTagger
@IN DataRecord
@OUT LogFile @URI file:{LogFile}
@LOG {timestamp} [{loglevel}] ACTOR<{actorname}> -> isMarine={isMarineValue} for occurrenceID={occurrenceId}
@OUT TaggedDataRecord
@END EnvironmentTagger
Pass only records tagged with isMarine=true
@BEGIN FilterToJustMarine
@IN TaggedDataRecord
@OUT LogFile @URI file:{LogFile}
@LOG {timestamp} [{loglevel}] ACTOR<{actorname}> ->  [{filterKey}]=[{matchValue}]:{match}. Passing occurrenceID={occurrenceID}
@OUT Marine
@End FilterToJustMarine
Pass only records not tagged with isMarine=true
@BEGIN FilterExcludingMarine
@IN TaggedDataRecord
@OUT LogFile @URI file:{LogFile}
@LOG {timestamp} [{loglevel}] ACTOR<{actorname}> ->  [{filterKey}]=[{matchValue}]:{match}. Passing occurrenceID={occurrenceID}
@OUT NotMarine
@END FilterExcludingMarine
Lookup GUIDs for names in WoRMS
@BEGIN WoRMSLookup
@IN Marine
@OUT WoRMSOutput
@END WoRMSLookup
Lookup GUIDs for names in GBIF
@BEGIN GBIFLookup
@IN NotMarine
@OUT GBIFOutput
@END GBIFLookup
Merge the streams
@BEGIN StreamMerge
@IN GBIFOutput
@IN WoRMSOutput
@OUT MergedStream
@END StreamMerge
@BEGIN CsvFileWriter
@IN Workspace
@IN MergedStream
Write to a csv file
@OUT OutputFile @URI file:{Workspace}/mergedoutputfile.csv
@END CsvFileWriter
Inline python actor to take care of any unfinished business and finish the workflow.
Inline python code to run.
The function to run when an on_data message is received. Accepts a dictionary
of options.
## Finished Wrapup ###'
A list of parameters to get from the options dictionary passed from an
upstream actor.
Get the workspace for this actor from the workspace in the options dictionary.
Full path to the output file.
Get the success state from the options dictionary of the previous step
Get the message from the options dictionary of the previous step
Dictionary of persistent objects created.
Show the name of the upstream actor.
The "upstream" actor from which to receive a message.
@OUT OutputFile
@OUT LogFile
@END BranchingWorkflow
